<?xml version="1.0"?>
<robot xmlns:xacro="http://ros.org/wiki/xacro" name="my_robot">
    <!--  ===================MATERIALS============  -->
    <material name="blue">
        <color rgba="0 0 0.8 1"/>
    </material>
    <material name="white">
        <color rgba="1 1 1 1"/>
    </material>
    <!--  ================MACROS==================  -->
    <!--basic box-->
    <xacro:macro name="box_link" params="name size_a size_b size_c color mass ixx ixy ixz iyy iyz izz">
        <link name="${name}">
            <visual>
                <geometry>
                <box size="${size_a} ${size_b} ${size_c}"/>
                </geometry>
                <material name="${color}"/>
            </visual>
            <collision>
                <geometry>
                    <box size="${size_a} ${size_b} ${size_c}"/>
                </geometry>
            </collision>
            <inertial>
                <mass value="${mass}"/>
                <origin xyz="0 0 0" rpy="0 0 0"/>
                <inertia ixx="${ixx}" ixy="${ixy}" ixz="${ixz}" iyy="${iyy}" iyz="${iyz}" izz="${izz}"/>
            </inertial>
        </link>
    </xacro:macro>
    <!-- fixed joints -->
    <xacro:macro name="fixed_joint" params="name parent child origin_x origin_y origin_z rpy_x rpy_y rpy_z">
    <joint name="${name}" type="fixed">
        <parent link="${parent}"/>
        <child link="${child}"/>
        <origin xyz="${origin_x} ${origin_y} ${origin_z}" rpy="${rpy_x} ${rpy_y} ${rpy_z}"/>
    </joint>
    </xacro:macro>
    <!--Wheel macro-->
    <xacro:macro name="wheel_macro" params="name length radius origin_x origin_y origin_z axis_z rpy_x">
        <link name="${name}">
            <visual>
                <geometry>
                    <cylinder length="${length}" radius="${radius}"/>
                </geometry>
                <material name="blue"/>
            </visual>
            <collision>
                <geometry>
                    <cylinder length="${length}" radius="${radius}"/>
                </geometry>
            </collision>
            <inertial>
                <mass value="0.025"/>
                <inertia ixx="0.000008" ixy="0.0" ixz="0.0" iyy="0.000008" iyz="0.0" izz="0.000016"/>
            </inertial>
        </link>
        <joint name="base_to_${name}" type="continuous">
            <parent link="base_link"/>
            <child link="${name}"/>
            <origin xyz="${origin_x} ${origin_y} ${origin_z}" rpy="${rpy_x} 0 0"/>
            <axis xyz="0 0 ${axis_z}"/>
        </joint>
    </xacro:macro>

    <!-- marker macro -->
    <xacro:macro name="marker_macro" params="name size_a size_b size_c parent_link origin_x origin_y origin_z">
        <xacro:box_link name="${name}" size_a="${size_a}" size_b="${size_b}" size_c="${size_c}" color="white" mass="0"
        ixx="0.0" ixy="0.0" ixz="0.0" iyy="0.0" iyz="0.0" izz="0.0"/>
        <xacro:fixed_joint name="${name}_joint" parent="${parent_link}" child="${name}" origin_x="${origin_x}" origin_y="${origin_y}" 
        origin_z="${origin_z}" rpy_x="0" rpy_y="0" rpy_z="0"/>
    </xacro:macro>
    <!-- ======================BASE AND BUILD====================-->
    <!--dummy link-->
    <link name="base_footprint"/>
    <!--Base-->
    <xacro:box_link name="base_link" size_a="0.33" size_b="0.34" size_c="0.01" color="blue" mass = "0.2"
    ixx="0.0019" ixy="0.0" ixz="0.0" iyy="0.0018" iyz="0.0" izz="0.0037"/>
    <!--wheels-->
    <xacro:wheel_macro name="left_wheel" length="0.01" radius="0.036" origin_x="0" origin_y="0.175" origin_z="0" axis_z="1" rpy_x="1.5708"/>
    <xacro:wheel_macro name="right_wheel" length="0.01" radius="0.036" origin_x="0" origin_y="-0.175" origin_z="0" axis_z="-1" rpy_x="-1.5708"/>
    <!-- Head marker -->
    <xacro:box_link name="head_marker" size_a="0.03" size_b="0.03" size_c="0.03" color="blue" mass="0.02"
    ixx="3.00e-6" ixy="0.0" ixz="0.0" iyy="3.00e-6" iyz="0.0" izz="3.00e-6"/>
    <!-- Passive wheel holder -->
    <xacro:box_link name="passive_wheel_holder" size_a="0.02" size_b="0.02" size_c="0.03" color="blue" mass = "0.015"
    ixx="1.17e-6" ixy="0.0" ixz="0.0" iyy="1.17e-6" iyz="0.0" izz="5.00e-7"/>
   <!-- Passive wheel -->
    <link name="passive_wheel">
        <visual>
            <geometry>
                <sphere radius="0.01"/>
            </geometry>
            <material name="white"/>
        </visual>
        <collision>
            <geometry>
                <sphere radius="0.0105"/>
            </geometry>
        </collision>
        <inertial> <!-- Inertial for passive_wheel -->
            <mass value="0.01"/>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <inertia ixx="8.82e-7" ixy="0.0" ixz="0.0" iyy="8.82e-7" iyz="0.0" izz="8.82e-7"/>
        </inertial>
    </link>
    <!--wheel rotator markers-->
    <xacro:marker_macro name="lw_marker" size_a="0.03" size_b="0.03" size_c="0.001" parent_link="left_wheel" origin_x="0" origin_y="0" origin_z="-0.005"/>
    <xacro:marker_macro name="rw_marker" size_a="0.03" size_b="0.03" size_c="0.001" parent_link="right_wheel" origin_x="0" origin_y="0" origin_z="-0.005"/>
    
    <!--====================JOINTS FROM HERE=======================-->
    <!--For footprint and base-->
    <xacro:fixed_joint name="footprint_to_base" parent="base_footprint" child="base_link"
        origin_x="0" origin_y="0" origin_z="0.036" rpy_x="0" rpy_y="0" rpy_z="0"/>
    <!-- Head fixed joint -->
    <xacro:fixed_joint name="base_to_head" parent="base_link" child="head_marker"
        origin_x="0.15" origin_y="0" origin_z="0.02" rpy_x="0" rpy_y="0" rpy_z="0"/>
    <!-- Passive wheel holder joint -->
    <xacro:fixed_joint name="base_to_passive_holder" parent="base_link" child="passive_wheel_holder"
        origin_x="0.15" origin_y="0" origin_z="-0.01" rpy_x="0" rpy_y="0" rpy_z="0"/>
    <!-- Passive wheel to holder -->
    <xacro:fixed_joint name="holder_to_passive_wheel" parent="passive_wheel_holder" child="passive_wheel"
        origin_x="0" origin_y="0" origin_z="-0.016" rpy_x="0" rpy_y="0" rpy_z="0"/>






    <!-- ========== GAZEBO / PLUGINS ========== -->

    <!-- Physical properties definitions (friction, etc.) -->
    <gazebo reference="base_link">
        <mu1>0.2</mu1>
        <mu2>0.2</mu2>
        <kp>100000</kp>
        <kd>1.0</kd>
        <material>Gazebo/Black</material>
    </gazebo>
    <gazebo reference="left_wheel">
        <mu1>0.9</mu1>
        <mu2>0.9</mu2>
        <kp>100000</kp>
        <kd>1.0</kd>
        <material>Gazebo/Black</material>
    </gazebo>
    <gazebo reference="right_wheel">
        <mu1>0.9</mu1>
        <mu2>0.9</mu2>
        <kp>100000</kp>
        <kd>1.0</kd>
        <material>Gazebo/Black</material>
    </gazebo>
    <gazebo reference="passive_wheel">
        <mu1>0.0</mu1>
        <mu2>0.0</mu2>
        <kp>100000</kp>
        <kd>1.0</kd>
        <material>Gazebo/Grey</material>
    </gazebo>

    <!-- Differential drive plugin -->
    <gazebo>
        <plugin name="diff_drive_controller" filename="libgazebo_ros_diff_drive.so">
            <ros>
                <remapping>odom:=diff_cont/odom</remapping>
            </ros>
            <update_rate>30.0</update_rate>
            <left_joint>base_to_left_wheel</left_joint>
            <right_joint>base_to_right_wheel</right_joint>
            <wheel_separation>0.34</wheel_separation>
            <wheel_diameter>0.072</wheel_diameter>

            <odom_frame>map</odom_frame>
            <robot_base_frame>base_footprint</robot_base_frame>

            <publish_odom>true</publish_odom>
            <publish_odom_tf>true</publish_odom_tf>
            <publish_wheel_tf>true</publish_wheel_tf>
            <odometry_source>0</odometry_source>
            <command_topic>/cmd_vel</command_topic>

            <command_topic>cmd_vel</command_topic>
            <max_wheel_torque>2.0</max_wheel_torque>
            <max_wheel_acceleration>0.5</max_wheel_acceleration>
        </plugin>
    </gazebo>


</robot>
